rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザー認証が必要な基本ルール
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ユーザー個人データ - プロフィールは公開読み取り、編集は本人のみ
    match /users/{userId} {
      allow read: if true; // プロフィールを公開読み取りに変更
      allow write: if isOwner(userId);

      // ユーザーのサブコレクション（selectedAnime, meishies, friends等）
      match /{subcollection}/{document} {
        allow read: if subcollection == "selectedAnime" || 
                      subcollection == "favorites" || 
                      subcollection == "meishies" ||
                      isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // アニメタイトルデータ - 認証済みユーザーは読み取りのみ
    match /titles/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // 管理者のみ（コンソールから）
    }
    
    // フレンド関係 - 関係者のみアクセス可能
    match /friends/{document} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.friendId);
    }
    
    // その他のコレクションは認証必須
    match /{collection}/{document} {
      allow read, write: if isAuthenticated();
    }
  }
}